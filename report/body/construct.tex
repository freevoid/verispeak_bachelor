\chapter{Конструкторский раздел}
Данный раздел содержит описание архитектуры разрабатываемого программного комплекса, а также ключевые алгоритмы, описывающие логику разрабатываемой системы.

\section{Общая архитектура разрабатываемого комплекса}
\label{sec:main_arch}

Общая архитектура комплекса представлена на рисунке~\ref{fig:main_arch}.

\begin{figure}[h]
    \center{\includegraphics[width=0.8\textwidth]{include/main_arch_dia.pdf}}
    \caption{Общая архитектура разрабатываемого программного комплекса}
    \label{fig:main_arch}
\end{figure}

В разрабатываемом программном комплексе можно выделить четыре основные подсистемы, перечисленные по уровню абстракции:
\begin{itemize}
\item Интерфейс пользователя -- приложение, позволяющее пользователю производить регистрацию и аутентификацию в системе, реализующее передачу данных с микрофона пользователя на сервер (для сохранения в базе данных и последующей обработки);
\item Контроллер сервера -- часть системы, выполняющая роль посредника между запросами пользователя и остальными подсистемами. Задача контроллера состоит в обработке запросов от интерфейса пользователя, передаче управления в соответствующие модули системы, обработке и выдаче результатов обратно в интерфейс;
\item Подсистема обучения модели (подсистема регистрации) -- позволяет получить по заданным речевым последовательностям (набору звуковых файлов в базе) персональную модель пользователя, сохранив ее в базе для последующего использования в процессе аутентификации;
\item Подсистема голосовой аутентификации -- подсистема, позволяющая определить, принадлежит ли заданная речевая последовательность (в виде набора звуковых файлов в базе) заданному пользователю (персональная модель которого создается на этапе регистрации в системе);
\item Подсистема хранения речевых данных пользователей (база данных);
\item Библиотека инструментов для голосовой аутентификации -- ядро программного комплекса, реализующее подходы, выбранные в результате обзора существующих решений в разделе~\ref{sec:overview} и предоставляющее интерфейс для подсистем голосовой аутентификации и регистрации.
\end{itemize}

\section{Варианты использования}

На рисунке~\ref{fig:use_cases} представлена диаграмма вариантов использования системы.

\begin{figure}[htp!]
    \center{\includegraphics[width=0.8\textwidth]{include/use_cases_dia.pdf}}
    \caption{Диаграмма вариантов использования системы}
    \label{fig:use_cases}
\end{figure}

Пользователей программного комплекса можно разделить на две категории:
\begin{itemize}
\item Пользователь системы аутентификации~-- основной пользователь, использующий
систему для прохождения аутентификации на некотором ресурсе. Пользователь имеет
возможность зарегистрироваться в системе, получив при этом персональную модель
источника речи, обученную на нескольких образцах фразы, которую он должен
повторить в процессе регистрации. После прохождения процесса регистрации
пользователь может использовать систему для аутентификации на сайте, при этом,
пройдя аутентификацию, пользователь будет обладать теми же правами, которыми он
обладал бы, войдя на ресурс традиционным способом (по паролю). В качестве
дополнительных функций, пользователь имеет возможность <<дообучить>>
персональную модель по записям, которые накопились за время использования им
системы, или же по предоставленным им при регистрации, получив, таким образом, более точную модель;
\item Администратор~-- пользователь, наделенный правами на просмотр истории посещений через специализированный интерфейс. Помимо этого, данный тип пользователя может добавлять, редактировать и удалять параметры, влияющие на процесс аутентификации, такие как пути к файлам моделей источников речи, текущая активная модель источника речи для пользователя, величина входного порога для пользователя (определяющий параметр для принятия решения, описанный в разделе~\ref{seq:analytic:decision}). Помимо этого, администратор имеет возможность просматривать журнал, в котором ведется запись основных событий системы, а также фиксируются возникающие ошибки и предупреждения.
\end{itemize}

\section{Подсистема обучения модели (стадия регистрации)}

При обучении модели пользователю необходимо предоставить несколько образцов,
записей <<кодовой фразы>>, ту же фразу он должен будет впоследствии произнести
для входа в систему по голосу. Для обзора прохождения процесса регистрации с
точки зрения времени, рассмотрим диаграмму последовательности, представленную на
рисунке~\ref{fig:seq_enrollment}:

\begin{figure}[hp!]
    \center{
        \fontsize{12}{14}\selectfont
        \input{tex_include/seq_enrollment_embedded.tex}
    }
    \caption{Диаграмма последовательности: процесс регистрации в системе}
    \label{fig:seq_enrollment}
\end{figure}

\begin{enumerate}
\item Пользователь инициирует процесс регистрации, интерфейс пользователя
посылает сообщение \Code{register()} контроллеру;
\item Контроллер на стороне сервера создает новую сессию записи, генерируя при
этом уникальный код сессии (\Code{session\_id}), который передается клиенту и
используется в дальнейшем для проверки аутентичности клиента. Состояние
созданной сессии устанавливается в <<Ожидание речевых данных>>;
\item Пользователь производит запись кодовой фразы несколько
раз\footnote{Необходимое количество должно быть определено экспериментально, см.
раздел~\ref{seq:experiment}.}, при этом каждая запись отправляется на сервер и
сохраняется в базе, путь к записи добавляется в данные сессии;
\item После завершения записи фразы, пользователь подтверждает регистрацию, при
этом интерфейс отправляет контроллеру сообщение \Code{confirm()}, после чего
процесс регистрации переходит в состояние <<Обучение модели>> (\Code{started}),
а контроллер ставит соответствующую сессию записи в очередь на обучение, посылая
сообщение \Code{enroll} ядру системы (подсистеме регистрации);
\item Интерфейс клиента опрашивает контроллер с заданной периодичностью о
состоянии процесса регистрации. Опрос продолжается до тех пор, пока состояние не
окажется одним из тупиковых: <<Обучение завершено>>, <<Ошибка при обучении>> или
<<Обучение прервано>>. На диаграмме показана стереотипная ситуация, при которой
регистрация происходит в штатном режиме (обучение проходит успешно).
\item \label{enum:enroll} Подсистема регистрации, обслуживающая очередь запросов
на обучение модели от контроллера, получает новую заявку и начинает процесс
обучения:
    \begin{enumerate}
        \item Получает контекст сессии (\Code{get\_session\_context}), в котором
        содержатся пути к файлам записей, код сессии и другая информация;
        \item Обращаясь к хранилищу (файловой системе), считывает в память файлы
        записей (\Code{read\_wav});
        \item Вызывает функцию библиотеки инструментов для аутентификации
        \Code{enroll}, передавая параметры обучения, в том числе считанные
        данные.
    \end{enumerate}
\end{enumerate}

Как видно из рисунка~\ref{fig:seq_enrollment} и данного выше описания, сам
процесс обучения происходит отдельно от взаимодействия клиентов и контроллера,
поскольку обучение требует больших вычислительных ресурсов и не может
происходить в том же потоке выполнения, что и клиент-серверное взаимодействие.
В таком случае, процессы обучения рассматриваются подсистемой регистрации как
заявки на обучения и ставятся контроллером в очередь, выполняясь по одиночке и,
тем самым, снижая нагрузку на сервер.

На рисунке~\ref{fig:enrollment_server_sd} представлена диаграмма состояний
для процесса регистрации пользователя в системе голосовой аутентификации (то
есть процесса обучения новой модели по речевым данным пользователя) с точки
зрения сервера. Переходы между состояниями описаны выше при рассмотрении
диаграммы последовательности.

\begin{figure}
    \center{\includegraphics[width=0.8\textwidth]{include/enrollment_server_sd_dia.pdf}}
    \caption{Диаграмма состояний для процесса обучения модели (сервер)}
    \label{fig:enrollment_server_sd}
\end{figure}

На рисунке~\ref{fig:enrollment_client_sd} представлена диаграмма состояний для
процесса регистрации пользователя в системе голосовой аутентификации со стороны
пользовательского интерфейса.
\begin{figure}[htp!]
    \center{\includegraphics[width=0.9\textwidth]{include/enrollment_client_sd_dia.pdf}}
    \caption{Диаграмма состояний для процесса обучения модели (клиент)}
    \label{fig:enrollment_client_sd}
\end{figure}


Опишем возможные состояния процесса регистрации с точки зрения интерфейса
пользователя:

\begin{itemize}
\item Создан~--- начальное состояние, ожидание начала записи кодовых фраз;
\item Запись~--- запись в процессе;
\item Останавливается~--- пользователь инициировал остановку записи (или
остановка инициирована автоматически при достижении максимальной длины записи);
\item Остановлено~--- запись завершена и в данный момент находится в памяти
клиента. В данном состоянии проверяется, достаточно ли длины записи для отправки
на сервер (запись не должна быть слишком короткой\footnote{Минимальная
допустимая длина записи должна определяться экспериментально.});
\item Недостаточно для отправления~--- запись слишком короткая. При этом
возможно возобновление записи (или отмена процесса);
\item Отправка на сервер~--- запись достаточной длины, инициируется отправка
данных на сервер. Находясь в данном состоянии, пользовательский интерфейс
ожидает передачи данных и положительного ответа сервера, оповещающего о приеме;
\item Ошибка при отправлении~--- данное состояние возникает, если при
отправлении данных на сервер возникла ошибка (соединение оборвалось, сервер не
смог прочитать данные и т.п.);
\item Отправлено~--- отправление звуковой записи успешно завершено,
пользовательский интерфейс готов к записи новой фразы. Из этого состояния
возможен переход вновь в состояние записи, отмена процесса регистрации или же
подтверждение (после отправления на сервер минимально допустимого для
регистрации количества записей);
\item Подтверждено~--- сервер ответил, оповестив о постановке в очередь запроса
на обучение модели, переход в следующее состояние;
\item Обучение в процессе~--- в данном состоянии интерфейс периодически
опрашивает сервер о состоянии процесса обучения (см.
рисунок~\ref{fig:enrollment_server_sd});
\item Недостаточно данных для обучения~--- обучение завершилось неудачей из-за
недостаточного количества речевых данных. В данном случае пользователь может
вернуться к записи фразы или отменить процесс регистрации;
\item Ошибка при обучении~--- при обучении произошла непредвиденная ошибка, в
данном случае повторное обучение по тем же данным невозможно, пользователю
предложено повторить процесс сначала;
\item Обучение завершено~--- обучение успешно завершено, система готова
производить аутентификацию данного пользователя по голосу;
\item Отменено~--- в данное состояние возможен переход, если пользователь
отказывается от продолжения процесса регистрации на некотором его этапе.
\end{itemize}

\section{Подсистема голосовой аутентификации}

В результате завершения процесса регистрации в системе голосовой аутентификации,
на сервере сохраняется персональная модель для пользователя. При этом для
данного пользователя фиксируется индивидуальный порог вхождения (который
впоследствии может быть скорректирован вручную). Модель пользователя, порог
вхождения и универсальная фоновая модель -- достаточный контекст для проведения
процедуры аутентификации (подробнее см. разделы~\ref{seq:analytic:ubm},
\ref{seq:analytic:decision}).

На рисунке~\ref{fig:seq_verification} представлена диаграмма последовательности
для процесса аутентификации.

\begin{figure}[htp!]
    \center{
        \fontsize{12}{14}\selectfont
        \input{tex_include/seq_verification_embedded.tex}
    }
    \caption{Диаграмма последовательности: процесс аутентификации}
    \label{fig:seq_verification}
\end{figure}

Диаграмма аналогична соответствующей диаграмме для процесса регистрации, поэтому
в дальнейшем описании ограничимся лишь принципиальными различиями между двумя
процессами. Рассмотрим основные этапы процесса аутентификации:

\begin{enumerate}
\item Пользователь инициирует процесс аутентификации, интерфейс пользователя
посылает сообщение \Code{verify()} контроллеру;
\item Контроллер на стороне сервера создает новую сессию записи, генерируя при
этом уникальный код сессии (\Code{session\_id}), состояние
созданной сессии устанавливается в <<Ожидание речевых данных>>;
\item Пользователь производит запись кодовой фразы единожды, после чего запись
отправляется на сервер (\Code{upload(data)}) и сохраняется в базе
(\Code{save\_upload\_wav(filename, data)});
\item После сохранения записанной фразы в базе, контроллер ставит запрос на
аутентификацию в очередь, посылая сообщение \Code{verificate(session\_id)}
подсистеме аутентификации, обслуживающей очередь запросов. Состояние процесса
при этом устанавливается в <<Аутентификация в процессе>>;
\item Интерфейс клиента опрашивает контроллер с заданной периодичностью о
состоянии процесса аутентификации. Опрос продолжается до тех пор, пока состояние
не окажется одним из тупиковых: <<Ошибка в процессе аутентификации>> или
<<Аутентификация успешно завершена>>. В последнем случае, контроллер возвращает
результат аутентификации (булево значение), предварительно завершая все
необходимые действия, по аутентификации и авторизации сессии пользователя в
интернет-портале.
\item \label{enum:verificate} Подсистема аутентификации, обслуживающая очередь
запросов от контроллера, получает новую заявку и начинает процесс аутентификации:
    \begin{enumerate}
        \item Получает контекст сессии (\Code{get\_session\_context}), в котором
        содержатся пути к файлам записей (обычно файл один), код сессии и другая
        информация;
        \item Обращаясь к хранилищу (файловой системе), считывает в память файлы
        записей (\Code{read\_wav}), а также модель источника речи, созданную в
        процессе регистрации и универсальную фоновую модель (\Code{read\_model});
        \item Вызывает функцию библиотеки инструментов для аутентификации
        \Code{verify}, передавая модель пользователя, универсальную фоновую
        модель, порог вхождения и считанные речевые данные.
    \end{enumerate}
\end{enumerate}

На рисунке~\ref{fig:verification_server_sd} представлена диаграмма состояний
для процесса аутентификации пользователя по голосу с точки зрения сервера.
Переходы между состояниями описаны выше при рассмотрении диаграммы
последовательности.

\begin{figure}
    \center{\includegraphics[width=0.8\textwidth]{include/verification_server_sd_dia.pdf}}
    \caption{Диаграмма состояний для процесса аутентификации (сервер)}
    \label{fig:verification_server_sd}
\end{figure}

На рисунке~\ref{fig:verification_client_sd} представлена диаграмма состояний для
процесса аутентификации пользователя по голосу с точки зрения пользовательского
интерфейса.

\begin{figure}[htp!]
    \center{\includegraphics[width=0.9\textwidth]{include/verification_client_sd_dia.pdf}}
    \caption{Диаграмма состояний для процесса аутентификации (клиент)}
    \label{fig:verification_client_sd}
\end{figure}

Состояния и переходы аналогичны соответствующим для процесса регистрации
(рисунок~\ref{fig:enrollment_client_sd}), опишем принципиальные различия:

\begin{enumerate}
\item Конечное состояние в случае успешного завершения процесса аутентификации
распадается на два: <<Успешная аутентификация>> (подразумевается результат
аутентификации, а не успешное завершение самого процесса) и <<В доступе
отказано>>. В первом случае система перенаправляет пользователя на ресурс,
который он запросил (или на страницу по-умолчанию).
\item После отправки записи на сервер, интерфейс пользователя сразу переходит в
состояние <<Аутентификация в процессе>> (аналогичное состоянию <<Обучение в
процессе>>), так как для аутентификации требуется только одна запись кодовой
фразы.
\end{enumerate}

Рассмотрим процесс аутентификации с точки зрения потоков данных и функций. На
рисунке~\ref{fig:idef0_main} показана диаграмма функциональных блоков для
процесса верификации.

\begin{figure}
    \center{
    \begin{sideways}
        \includegraphics[width=0.9\textheight]{include/idef0_main_dia.pdf}
    \end{sideways}
    }
    \caption{Диаграмма функциональных блоков A0: аутентификация по голосу}
    \label{fig:idef0_main}
\end{figure}

\begin{figure}
    \center{
    \begin{sideways}
    \includegraphics[width=0.9\textheight]{include/idef0_pre_dia.pdf}
    \end{sideways}
    }
    \caption{Диаграмма функциональных блоков A1: подготовка входных данных}
    \label{fig:idef0_pre}
\end{figure}

\section{Подсистема хранения голосовых данных}

На рисунке~\ref{fig:er_main} представлена диаграмма сущность-связь для разрабатываемой базы данных. Рассмотрим подробнее сущности, представленные на данной диаграмме:

\begin{itemize}
\item Пользователь;
\item Модель источника речи;
\item Сессия записи;
\item Сессия верификации;
\item Сессия регистрации;
\item Верификатор;
\item Записанное высказывание;
\item Процесс обучения;
\item Процесс аутентификации.
\end{itemize}

\begin{figure}
    %\input{tex_include/er_main_embedded.tex}
    %\center{\drawER{0.65}{1.0cm}}
    \center{\includegraphics[width=\textwidth]{include/er_main_tex.pdf}}
    \caption{Диаграмма сущность-связь подсистемы хранения голосовых данных}
    \label{fig:er_main}
\end{figure}

%Следует отметить, что база данных предназначена для хранения вспомогательной информации, тогда как непосредственно голосовые данные должны храниться 

\section{Основные алгоритмы}

\subsection{Удаление тишины}

Как для процесса обучения, так и для процесса аутентификации, для достижения адекватных показателей ошибок необходима нормализация входных речевых данных. Одним из наиболее важных этапов при применении гауссовых смесей\footnote{Причиной важности является тексто-независимость метода. Паузы между словами и предложениями можно рассматривать как характерные признаки источника речи, однако, используемый метод предназначен для моделирования характеристик вокального тракта человека, а не столь высокоуровневых признаков.} является выделение из речевых данных только тех, которые вероятнее содержат речь, а не внешний шум.

Для отделения во входном сигнале речи от условной тишины (постоянного внешнего шума, создаваемого окружением) был разработан специализированный алгоритм, блок-схема которого показана на рисунке~\ref{fig:silence_remove_flowchart}.

\begin{figure}
    \center{
    \fontsize{12}{14}\selectfont
    \def\svgwidth{1.2\textwidth}
    \includesvg{silence_remove_flowchart}
    }
    \caption{Блок-схема алгоритма удаления <<тишины>> из входного сигнала}
    \label{fig:silence_remove_flowchart}
\end{figure}

